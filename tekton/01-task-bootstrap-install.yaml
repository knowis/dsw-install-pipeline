apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: bootstrap
spec:
  workspaces:
    - name: shared-wksp
      description: |
        Folder to read and write files to that are shared amongst tasks in the parent pipeline
  params:
    - name: default-step-image
      type: string
      description: Image to use to execute step
  results:
      - name: cluster-app-url
        description: "Url (suffix) for services exposed by the cluster"
  steps:
    - name: bootstrap-install
      image: "$(params.default-step-image)"
      script: |
        #!/usr/bin/bash
        set -e

        if [ "$(workspaces.shared-wksp.bound)" == "true" ] ; then
          echo "Sharing info via $(workspaces.shared-wksp.path)/message"
          echo "hello from bootstrap!" > $(workspaces.shared-wksp.path)/message
        else
          echo "Workspace shared-wksp not bound"
        fi
    - name: determine-cluster-app-host
      image: "$(params.default-step-image)"
      script: |
        #!/usr/bin/bash
        set -e

        echo "Createing dummy route to extract apps url from"
        SVC_NAME="dummy-route-$(tr -dc 'a-z0-9' < /dev/random | head -c 5)"
        oc create route edge --service=$SVC_NAME --port=34567
        oc get route $SVC_NAME -o jsonpath='{.spec.host}'|sed -nE 's/^.*(\.apps\..*$)/\1/p' | tee $(results.cluster-app-url.path)

        oc delete route $SVC_NAME

        echo "Deleted dummy route $SVC_NAME again"
